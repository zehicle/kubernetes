barclamp:
  name: kubernetes
  display: Kubernetes
  license: "restricted"
  copyright: "RackN, 2015"
  os_support:
    - ubuntu-14.04
    - ubuntu-15.04
    - centos-6.6
    - redhat-6.6
    - centos-7.1-1503
    - redhat-7.1

roles:
  - name: kubernetes-installed
    description: 'Kubernetes Installed - abstract'
    jig: noop

  - name: kubernetes-master
    description: 'Kubernetes Master'
    jig: noop
    requires:
      - kubernetes-master-install
      - kubernetes-master-secrets
      - kubernetes-network-config
    flags:
      - milestone
      - cluster
    attribs:
      - name: kubernetes-master-name
        description: "The name of the master name common FQDN"
        map: 'kubernetes_master_name'
        schema:
          type: str
        default: ""

  - name: kubernetes-node
    description: 'Kubernetes Node'
    jig: noop
    flags:
      - cluster
      - milestone
    requires:
      - kubernetes-node-install
      - kubernetes-network-config

  - name: kubernetes-gateway
    description: 'Kubernetes Gateway (Opencontrail)'
    jig: noop
    flags:
      - cluster
      - milestone
    requires:
      - kubernetes-gateway-install
      - kubernetes-network-config

  - name: kubernetes-docker
    description: 'Kubernetes Docker'
    jig: ansible-playbook
    flags:
      - implicit
    wants-attribs:
      - proxy-servers
      - use-proxy
      - nics

  # GREG: Note this doesn't handle multi-nodes well.
  # Currently, it relies on hostvars['ansible_hostname'] to build the peer list
  # Can replace with injection
  - name: kubernetes-etcd
    description: 'Etcd Cluster'
    jig: ansible-playbook
    flags:
      - cluster
      - milestone
    requires:
      - rebar-installed-node
    wants-attribs:
      - proxy-servers
      - nics
    attribs:
      - name: etcd-cluster-id
        description: "The name of the etcd cluster."
        map: 'etcd_initial_cluster_token'
        schema:
          type: str
        default: ""
      - name: etcd-peer-port
        default: 2380
        description: Port that etcd uses to talk amongst peers
        map: 'etcd_peer_port'
        schema:
          type: int
      - name: etcd-client-port
        default: 2379
        description: Port that etcd uses to talk to clients
        map: 'etcd_client_port'
        schema:
          type: int
      - name: etcd-nodes
        description: 'The list of nodes that will act as etcd members'
        map: 'etcd/nodes'
        schema:
          type: map
          mapping:
            =:
              type: str
              pattern: /[0-9a-f:.]*/

  - name: kubernetes-config
    jig: noop
    requires:
      - rebar-installed-node
    flags:
      - implicit
      - milestone
    attribs:
      - name: kubernetes-source_type
        description: "The install method for the recipes"
        map: 'source_type'
        default: 'packageManager'
        schema:
          type: str
          required: true
          enum:
            - packageManager
            - localBuild
      - name: kubernetes-cluster_name
        description: "The name of the cluster"
        map: 'cluster_name'
        default: 'cluster.local'
        schema:
          type: str
          required: true

      - name: kubernetes-kube_service_addresses
        description: "The service addresses for the kube service"
        map: 'kube_service_addresses'
        default: '10.254.0.0/16'
        schema:
          type: str
          required: true

      - name: kubernetes-network-category
        description: "The network category to use for contrail traffic"
        map: 'opencontrail_network_category'
        default: 'admin'
        schema:
          type: str

      - name: kubernetes-networking
        description: "The method of networking for the cluster"
        map: 'networking'
        default: 'flannel'
        schema:
          type: str
          required: true
          enum:
            - flannel
            - opencontrail

      - name: kubernetes-opencontrail_public_subnet
        description: "The external network for opencontrail to use"
        map: 'opencontrail_public_subnet'
        default: '10.1.4.0/24'
        schema:
          type: str
      - name: kubernetes-opencontrail_private_subnet
        description: "The internal network for opencontrail to use"
        map: 'opencontrail_private_subnet'
        default: '192.168.1.0/24'
        schema:
          type: str

      - name: kubernetes-flannel_subnet
        description: "The flannel subnet for the cluster"
        map: 'flannel_subnet'
        default: '172.32.0.0'
        schema:
          type: str
      - name: kubernetes-flannel_prefix
        description: "The flannel prefix for the cluster"
        map: 'flannel_prefix'
        default: 12
        schema:
          type: int
      - name: kubernetes-flannel_host_prefix
        description: "The flannel host prefix for the cluster"
        map: 'flannel_host_prefix'
        default: 24
        schema:
          type: int

      - name: kubernetes-cluster_logging
        description: "The cluster logging toggle to turn off (false) elasticsearch"
        map: 'cluser_logging'
        default: true
        schema:
          type: bool
      - name: kubernetes-cluster_monitoring
        description: "The cluster monitoring toggle to turn off (false) heapster and influxdb"
        map: 'cluser_monitoring'
        default: true
        schema:
          type: bool
      - name: kubernetes-kube-ui
        description: "The kube-ui toggle to turn off (false) the kube-ui addon"
        map: 'kube-ui'
        default: true
        schema:
          type: bool
      - name: kubernetes-dns_setup
        description: "The dns internal server toggle to turn off (false)"
        map: 'dns_setup'
        default: true
        schema:
          type: bool
      - name: kubernetes-dns_replicas
        description: "The number of replicas to use in the cluster"
        map: 'dns_replicas'
        default: 1
        schema:
          type: int

  - name: kubernetes-master-install
    jig: ansible-playbook
    provides:
      - kubernetes-installed
    requires:
      - kubernetes-etcd
      - kubernetes-config
      - kubernetes-network-install
    wants-attribs:
      - kubernetes-dns_replicas
      - kubernetes-dns_setup
      - kubernetes-kube-ui
      - kubernetes-cluster_monitoring
      - kubernetes-cluster_logging
      - kubernetes-flannel_host_prefix
      - kubernetes-flannel_prefix
      - kubernetes-flannel_subnet
      - kubernetes-network-category
      - kubernetes-opencontrail_private_subnet
      - kubernetes-opencontrail_public_subnet
      - kubernetes-networking
      - kubernetes-kube_service_addresses
      - kubernetes-cluster_name
      - kubernetes-source_type
      - proxy-servers
      - nics
    flags:
      - implicit

  - name: kubernetes-node-install
    jig: ansible-playbook
    provides:
      - kubernetes-installed
    requires:
      - kubernetes-config
      - kubernetes-master
      - kubernetes-network-install
    wants-attribs:
      - kubernetes-dns_replicas
      - kubernetes-dns_setup
      - kubernetes-kube-ui
      - kubernetes-cluster_monitoring
      - kubernetes-cluster_logging
      - kubernetes-flannel_host_prefix
      - kubernetes-flannel_prefix
      - kubernetes-flannel_subnet
      - kubernetes-network-category
      - kubernetes-opencontrail_private_subnet
      - kubernetes-opencontrail_public_subnet
      - kubernetes-networking
      - kubernetes-kube_service_addresses
      - kubernetes-cluster_name
      - kubernetes-source_type
      - use-proxy
      - proxy-servers
      - nics
    flags:
      - implicit

  - name: kubernetes-gateway-install
    jig: ansible-playbook
    provides:
      - kubernetes-installed
    requires:
      - kubernetes-config
      - kubernetes-master
      - kubernetes-network-install
    wants-attribs:
      - kubernetes-dns_replicas
      - kubernetes-dns_setup
      - kubernetes-kube-ui
      - kubernetes-cluster_monitoring
      - kubernetes-cluster_logging
      - kubernetes-flannel_host_prefix
      - kubernetes-flannel_prefix
      - kubernetes-flannel_subnet
      - kubernetes-network-category
      - kubernetes-opencontrail_private_subnet
      - kubernetes-opencontrail_public_subnet
      - kubernetes-networking
      - kubernetes-kube_service_addresses
      - kubernetes-cluster_name
      - kubernetes-source_type
      - use-proxy
      - proxy-servers
      - nics
    flags:
      - implicit

  - name: kubernetes-complete
    jig: noop
    requires:
      - kubernetes-master
      - kubernetes-node
    flags:
      - implicit

  - name: kubernetes-add-ons
    jig: ansible-playbook
    requires:
      - kubernetes-complete
    wants-attribs:
      - kubernetes-dns_replicas
      - kubernetes-dns_setup
      - kubernetes-kube-ui
      - kubernetes-cluster_monitoring
      - kubernetes-cluster_logging
      - kubernetes-flannel_host_prefix
      - kubernetes-flannel_prefix
      - kubernetes-flannel_subnet
      - kubernetes-network-category
      - kubernetes-opencontrail_private_subnet
      - kubernetes-opencontrail_public_subnet
      - kubernetes-networking
      - kubernetes-kube_service_addresses
      - kubernetes-cluster_name
      - kubernetes-source_type
      - use-proxy
      - proxy-servers
      - nics
    flags:
      - implicit
      - milestone

  - name: kubernetes-test
    jig: ansible-playbook
    requires:
      - kubernetes-add-ons
    wants-attribs:
      - kubernetes-dns_replicas
      - kubernetes-dns_setup
      - kubernetes-kube-ui
      - kubernetes-cluster_monitoring
      - kubernetes-cluster_logging
      - kubernetes-kube_service_addresses
      - kubernetes-cluster_name
      - kubernetes-source_type
      - use-proxy
      - proxy-servers
      - nics
    flags:
      - implicit
      - milestone

  - name: kubernetes-network-install
    description: 'Kubernetes Network Install'
    jig: noop
    flags:
      - implicit
    requires:
      - kubernetes-docker

  - name: kubernetes-flannel-install
    description: 'Kubernetes Flannel Install'
    jig: ansible-playbook
    requires:
      - kubernetes-etcd
      - kubernetes-config
      - kubernetes-docker
    flags:
      - implicit
    wants-attribs:
      - kubernetes-networking
      - kubernetes-network-category
      - kubernetes-flannel_host_prefix
      - kubernetes-flannel_prefix
      - kubernetes-flannel_subnet
      - use-proxy
      - proxy-servers

  - name: kubernetes-opencontrail-install
    description: 'Kubernetes Opencontrail Install'
    jig: ansible-playbook
    requires:
      - kubernetes-config
      - kubernetes-docker
    flags:
      - implicit
    attribs:
      - name: opencontrail-cluster-type
        description: 'The type of opencontrail cluster'
        map: 'opencontrail_cluster_type'
        default: 'kubernetes'
        schema:
          type: str
          required: true
          enum:
            - kubernetes
    wants-attribs:
      - kubernetes-opencontrail_private_subnet
      - kubernetes-opencontrail_public_subnet
      - kubernetes-kube_service_addresses
      - kubernetes-source_type
      - use-proxy
      - proxy-servers

  - name: kubernetes-network-config
    description: 'Kubernetes Network Config'
    jig: noop
    requires:
      - kubernetes-config
      - kubernetes-installed
    flags:
      - implicit

  - name: kubernetes-flannel-config
    description: 'Kubernetes Flannel Config'
    jig: noop
    requires:
      - kubernetes-config
      - kubernetes-installed
    flags:
      - implicit

  - name: kubernetes-opencontrail-config
    description: 'Kubernetes Opencontrail Config'
    jig: ansible-playbook
    requires:
      - kubernetes-config
      - kubernetes-installed
    wants-attribs:
      - opencontrail-cluster-type
      - kubernetes-kube_service_addresses
      - kubernetes-opencontrail_private_subnet
      - kubernetes-opencontrail_public_subnet
      - kubernetes-network-category
      - kubernetes-cluster_name
      - kubernetes-source_type
      - use-proxy
      - proxy-servers
    flags:
      - implicit

  - name: kubernetes-master-secrets
    description: 'Kubernetes Master Secrets'
    jig: ansible-playbook
    requires:
      - kubernetes-master-install
    wants-attribs:
      - kubernetes-dns_replicas
      - kubernetes-dns_setup
      - kubernetes-kube-ui
      - kubernetes-cluster_monitoring
      - kubernetes-cluster_logging
      - kubernetes-flannel_host_prefix
      - kubernetes-flannel_prefix
      - kubernetes-flannel_subnet
      - kubernetes-network-category
      - kubernetes-opencontrail_private_subnet
      - kubernetes-opencontrail_public_subnet
      - kubernetes-networking
      - kubernetes-kube_service_addresses
      - kubernetes-cluster_name
      - kubernetes-source_type
      - proxy-servers
      - use-proxy
      - nics
    flags:
      - implicit

