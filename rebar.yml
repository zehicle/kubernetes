barclamp:
  name: kubernetes
  display: Kubernetes
  license: "restricted"
  copyright: "RackN, 2015"
  os_support:
    - ubuntu-14.04
    - ubuntu-15.04
    - centos-6.6
    - redhat-6.6
    - centos-7.1-1503
    - redhat-7.1

roles:
  - name: kubernetes-master
    description: 'Kubernetes Master'
    jig: noop
    requires:
      - kubernetes-downloader
      - kubernetes-etcd
      - rebar-installed-node
    flags:
      - milestone
      - cluster

  - name: kubernetes-node
    description: 'Kubernetes Node'
    jig: noop
    flags:
      - milestone
      - cluster
    requires:
      - kubernetes-master
      - rebar-installed-node

  - name: opencontrail-gateway
    description: 'Opencontrail Gateway'
    jig: noop
    flags:
      - milestone
      - cluster
    requires:
      - rebar-installed-node

  - name: kubernetes-etcd
    description: 'Etcd Cluster'
    jig: noop
    flags:
      - milestone
      - cluster
    requires:
      - rebar-installed-node

  - name: kubernetes-downloader
    description: 'Kubernetes Downloader'
    jig: noop
    flags:
      - milestone
    requires:
      - rebar-installed-node

  - name: kubernetes-deploy
    description: 'Kubernetes Deploy'
    jig: ansible-playbook
    flags:
      - milestone
    requires:
      - kubernetes-master
      - kubernetes-node
      - kubernetes-downloader
      - kubernetes-etcd
      - rebar-installed-node
    wants-attribs:
      - nics
      - use-proxy
      - proxy-servers
    attribs:
      - name: kubernetes-bin_dir
        description: "The local of binary files"
        map: 'bin_dir'
        default: '/usr/local/bin'
        schema:
          type: str
          required: true
      - name: kubernetes-local_release_dir
        description: "The local of release download directory"
        map: 'local_release_dir'
        default: '/tmp/releases'
        schema:
          type: str
          required: true
      - name: kubernetes-log_level
        description: "The kubernetes logging level"
        map: 'kube_log_level'
        default: 2
        schema:
          type: int
          required: true
      - name: kubernetes-users
        description: "The default set of users for kubernetes API"
        map: 'kube_users'
        default:
          kube:
            pass: changeme
            role: admin
        schema:
          type: map
          mapping:
            =:
              type: map
              mapping:
                =:
                  type: str
          required: true
      - name: kubernetes-cluster_name
        description: "The name of the cluster"
        map: 'cluster_name'
        default: 'cluster.local'
        schema:
          type: str
          required: true

      - name: kubernetes-kube_service_addresses
        description: "The service addresses for the kube service"
        map: 'kube_service_addresses'
        default: '10.233.0.0/18'
        schema:
          type: str
          required: true

      - name: kubernetes-network-category
        description: "The network category to use for contrail traffic"
        map: 'opencontrail_network_category'
        default: 'admin'
        schema:
          type: str

      - name: kubernetes-networking
        description: "The method of networking for the cluster"
        map: 'kube_network_plugin'
        default: 'flannel'
        schema:
          type: str
          required: true
          enum:
            - flannel
            - calico
            - opencontrail

      - name: kubernetes-pods_subnet
        description: "Subnet pods should use for calico and flannel"
        map: 'kube_pods_subnet'
        default: '10.233.64.0/18'
        schema:
          type: str
          required: true

      - name: kubernetes-network_prefix
        description: "The network prefix for the whole network"
        map: 'kube_network_prefix'
        default: 18
        schema:
          type: int
          required: true

      - name: kubernetes-network_node_prefix
        description: "The network prefix for the node part of the network"
        map: 'kube_network_node_prefix'
        default: 24
        schema:
          type: int
          required: true

      - name: kubernetes-peer_with_router
        description: "Should calico use bgp route distribution"
        map: 'peer_with_router'
        default: false
        schema:
          type: bool
          required: true
 
      - name: kubernetes-opencontrail_public_subnet
        description: "The external network for opencontrail to use"
        map: 'opencontrail_public_subnet'
        default: '10.1.4.0/24'
        schema:
          type: str
          required: true

      - name: kubernetes-opencontrail_private_subnet
        description: "The internal network for opencontrail to use"
        map: 'opencontrail_private_subnet'
        default: '192.168.1.0/24'
        schema:
          type: str
          required: true

      - name: kubernetes-apiserver_ip
        description: "Default IP of apiserver"
        map: 'kube_apiserver_ip'
        default: "{{ kube_service_addresses|ipaddr('net')|ipaddr(1)|ipaddr('address') }}"
        schema:
          type: str
          required: true

      - name: kubernetes-apiservier_port
        description: "The secure port for the API server"
        map: 'kube_apiserver_port'
        default: 443
        schema:
          type: int
          required: true

      - name: kubernetes-apiservier_insecure_port
        description: "The insecure port for the API server"
        map: 'kube_apiserver_insecure_port'
        default: 8080
        schema:
          type: int
          required: true

      - name: kubernetes-upstream_dns_servers
        description: "The set of upstream DNS servers"
        map: 'upstream_dns_servers'
        default:
          - 8.8.8.8
          - 4.4.8.8
        schema:
          type: seq
          sequence:
            - type: str
              pattern: /[0-9a-f:.]*/
      - name: kubernetes-dns_setup
        description: "The dns internal server toggle to turn off (false)"
        map: 'dns_setup'
        default: true
        schema:
          type: bool
      - name: kubernetes-dns_replicas
        description: "The number of replicas to use in the cluster"
        map: 'dns_replicas'
        default: 1
        schema:
          type: int
      - name: kubernetes-dns_domain
        description: "The default dns domain name"
        map: 'dns_domain'
        default: "{{ cluster_name }}"
        schema:
          type: str
      - name: kubernetes-dns_server
        description: "The default IP of the internal dns server"
        map: 'dns_server'
        default: "{{ kube_service_addresses|ipaddr('net')|ipaddr(2)|ipaddr('address') }}"
        schema:
          type: str

      - name: kubernetes-cluster_logging
        description: "The cluster logging toggle to turn off (false) elasticsearch"
        map: 'cluser_logging'
        default: true
        schema:
          type: bool
      - name: kubernetes-cluster_monitoring
        description: "The cluster monitoring toggle to turn off (false) heapster and influxdb"
        map: 'cluser_monitoring'
        default: true
        schema:
          type: bool
      - name: kubernetes-kube-ui
        description: "The kube-ui toggle to turn off (false) the kube-ui addon"
        map: 'kube-ui'
        default: true
        schema:
          type: bool
      - name: etcd-cluster-id
        description: "The name of the etcd cluster."
        map: 'etcd_initial_cluster_token'
        schema:
          type: str
        default: ""
      - name: etcd-peer-port
        default: 2380
        description: Port that etcd uses to talk amongst peers
        map: 'etcd_peer_port'
        schema:
          type: int
      - name: etcd-client-port
        default: 2379
        description: Port that etcd uses to talk to clients
        map: 'etcd_client_port'
        schema:
          type: int

  - name: kubernetes-add-ons
    jig: ansible-playbook
    requires:
      - kubernetes-deploy
    wants-attribs:
      - nics
      - use-proxy
      - proxy-servers
      - name: kubernetes-bin_dir
      - name: kubernetes-local_release_dir
      - name: kubernetes-log_level
      - name: kubernetes-users
      - name: kubernetes-cluster_name
      - name: kubernetes-kube_service_addresses
      - name: kubernetes-network-category
      - name: kubernetes-networking
      - name: kubernetes-pods_subnet
      - name: kubernetes-network_prefix
      - name: kubernetes-network_node_prefix
      - name: kubernetes-peer_with_router
      - name: kubernetes-apiserver_ip
      - name: kubernetes-apiservier_port
      - name: kubernetes-apiservier_insecure_port
      - name: kubernetes-upstream_dns_servers
      - name: kubernetes-dns_setup
      - name: kubernetes-dns_replicas
      - name: kubernetes-dns_domain
      - name: kubernetes-dns_server
      - name: kubernetes-cluster_logging
      - name: kubernetes-cluster_monitoring
      - name: kubernetes-kube-ui
      - name: etcd-cluster-id
      - name: etcd-peer-port
      - name: etcd-client-port
      - name: etcd-nodes
    flags:
      - implicit
      - milestone

  - name: kubernetes-test
    jig: ansible-playbook
    requires:
      - kubernetes-add-ons
    wants-attribs:
      - nics
      - use-proxy
      - proxy-servers
      - name: kubernetes-bin_dir
      - name: kubernetes-local_release_dir
      - name: kubernetes-log_level
      - name: kubernetes-users
      - name: kubernetes-cluster_name
      - name: kubernetes-kube_service_addresses
      - name: kubernetes-network-category
      - name: kubernetes-networking
      - name: kubernetes-pods_subnet
      - name: kubernetes-network_prefix
      - name: kubernetes-network_node_prefix
      - name: kubernetes-peer_with_router
      - name: kubernetes-apiserver_ip
      - name: kubernetes-apiservier_port
      - name: kubernetes-apiservier_insecure_port
      - name: kubernetes-upstream_dns_servers
      - name: kubernetes-dns_setup
      - name: kubernetes-dns_replicas
      - name: kubernetes-dns_domain
      - name: kubernetes-dns_server
      - name: kubernetes-cluster_logging
      - name: kubernetes-cluster_monitoring
      - name: kubernetes-kube-ui
      - name: etcd-cluster-id
      - name: etcd-peer-port
      - name: etcd-client-port
      - name: etcd-nodes
    flags:
      - implicit
      - milestone

